<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>·ª®NG D·ª§NG KI·ªÇM TRA TR·∫ÆC NGHI·ªÜM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        .slide-up { animation: slideUp 0.6s ease-out; }
        .bounce-in { animation: bounceIn 0.8s ease-out; }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .card-gradient {
            background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
        }
        
        .toast {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease-in-out;
        }
        
        @media (min-width: 640px) {
            .toast {
                top: 20px;
                right: 20px;
            }
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .progress-bar {
            transition: width 0.3s ease;
        }
        
        .timer-warning {
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <!-- Header -->
    <header class="bg-white/10 backdrop-blur-md border-b border-white/20 sticky top-0 z-50">
        <div class="container mx-auto px-2 sm:px-4 py-3 sm:py-4">
            <div class="text-center">
                <h1 class="text-xl sm:text-2xl lg:text-3xl font-bold text-white mb-1 sm:mb-2 bounce-in leading-tight">·ª®NG D·ª§NG KI·ªÇM TRA TR·∫ÆC NGHI·ªÜM</h1>
                <p class="text-white/80 text-xs sm:text-sm fade-in">ƒê∆∞·ª£c t·∫°o b·ªüi: H·ªì H·ªØu Th·∫ø - 0935.078.895</p>
            </div>
        </div>
    </header>

    <!-- Tab Navigation -->
    <div class="container mx-auto px-2 sm:px-4 py-4 sm:py-6">
        <div class="bg-white/10 backdrop-blur-md rounded-xl p-1 sm:p-2 mb-4 sm:mb-6 slide-up">
            <div class="grid grid-cols-2 sm:flex sm:flex-wrap sm:justify-center gap-1 sm:gap-2">
                <button onclick="switchTab('exam')" id="tab-exam" class="tab-btn active px-2 sm:px-4 lg:px-6 py-2 sm:py-3 rounded-lg font-medium transition-all duration-300 text-xs sm:text-sm">
                    <span class="block sm:inline">üìù</span>
                    <span class="block sm:inline sm:ml-1">L√†m b√†i thi</span>
                </button>
                <button onclick="switchTab('manage')" id="tab-manage" class="tab-btn px-2 sm:px-4 lg:px-6 py-2 sm:py-3 rounded-lg font-medium transition-all duration-300 text-xs sm:text-sm">
                    <span class="block sm:inline">‚öôÔ∏è</span>
                    <span class="block sm:inline sm:ml-1">Qu·∫£n l√Ω</span>
                </button>
                <button onclick="switchTab('ranking')" id="tab-ranking" class="tab-btn px-2 sm:px-4 lg:px-6 py-2 sm:py-3 rounded-lg font-medium transition-all duration-300 text-xs sm:text-sm">
                    <span class="block sm:inline">üèÜ</span>
                    <span class="block sm:inline sm:ml-1">X·∫øp h·∫°ng</span>
                </button>
                <button onclick="switchTab('backup')" id="tab-backup" class="tab-btn px-2 sm:px-4 lg:px-6 py-2 sm:py-3 rounded-lg font-medium transition-all duration-300 text-xs sm:text-sm">
                    <span class="block sm:inline">üíæ</span>
                    <span class="block sm:inline sm:ml-1">Sao l∆∞u</span>
                </button>
            </div>
        </div>

        <!-- Tab Content -->
        <div id="exam-tab" class="tab-content">
            <!-- Student Info Form -->
            <div id="student-form" class="card-gradient rounded-xl p-4 sm:p-6 lg:p-8 shadow-2xl fade-in">
                <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-4 sm:mb-6 text-center">üìã Th√¥ng tin h·ªçc sinh</h2>
                
                <!-- Current Question Set Display -->
                <div class="bg-blue-50 p-3 sm:p-4 rounded-lg mb-4 sm:mb-6 border-l-4 border-blue-500">
                    <div class="text-center">
                        <span class="text-blue-600 font-semibold text-sm sm:text-base">üìö B·ªô c√¢u h·ªèi: </span>
                        <span class="text-blue-800 font-bold text-sm sm:text-base" id="exam-question-set-name">ƒêang t·∫£i...</span>
                    </div>
                </div>
                
                <form onsubmit="startExam(event)" class="space-y-4">
                    <div>
                        <label class="block text-gray-700 font-medium mb-2 text-sm sm:text-base">H·ªç v√† t√™n:</label>
                        <input type="text" id="student-name" required class="w-full px-3 sm:px-4 py-2 sm:py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm sm:text-base">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2 text-sm sm:text-base">L·ªõp:</label>
                        <input type="text" id="student-class" required class="w-full px-3 sm:px-4 py-2 sm:py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm sm:text-base">
                    </div>
                    <button type="submit" class="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white py-3 px-6 rounded-lg font-medium hover:from-blue-600 hover:to-purple-700 transition-all duration-300 transform hover:scale-105 text-sm sm:text-base">
                        üöÄ B·∫Øt ƒë·∫ßu l√†m b√†i
                    </button>
                </form>
            </div>

            <!-- Exam Interface -->
            <div id="exam-interface" class="hidden">
                <!-- Timer and Progress -->
                <div class="card-gradient rounded-xl p-3 sm:p-4 lg:p-6 shadow-2xl mb-4 sm:mb-6 fade-in">
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3 sm:gap-4">
                        <div class="flex items-center justify-between sm:justify-start sm:space-x-4">
                            <div id="elapsed-time" class="text-lg sm:text-xl lg:text-2xl font-bold text-green-600">‚è±Ô∏è 00:00</div>
                            <div class="text-gray-600 text-sm sm:text-base">
                                <span id="current-question">1</span> / <span id="total-questions">0</span>
                            </div>
                        </div>
                        <div class="flex-1 sm:max-w-md">
                            <div class="bg-gray-200 rounded-full h-2 sm:h-3">
                                <div id="progress-bar" class="progress-bar bg-gradient-to-r from-green-400 to-blue-500 h-2 sm:h-3 rounded-full" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Question Card -->
                <div class="card-gradient rounded-xl p-4 sm:p-6 lg:p-8 shadow-2xl mb-4 sm:mb-6 slide-up">
                    <div id="question-content">
                        <!-- Question will be loaded here -->
                    </div>
                </div>

                <!-- Navigation -->
                <div class="flex flex-col sm:flex-row justify-between items-stretch sm:items-center gap-3 sm:gap-0">
                    <button onclick="previousQuestion()" id="prev-btn" class="bg-gray-500 text-white px-4 sm:px-6 py-2 sm:py-3 rounded-lg font-medium hover:bg-gray-600 transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed text-sm sm:text-base order-2 sm:order-1">
                        ‚¨ÖÔ∏è C√¢u tr∆∞·ªõc
                    </button>
                    <button onclick="submitExam()" class="bg-red-500 text-white px-4 sm:px-6 py-2 sm:py-3 rounded-lg font-medium hover:bg-red-600 transition-all duration-300 text-sm sm:text-base order-1 sm:order-2">
                        üì§ N·ªôp b√†i
                    </button>
                    <button onclick="nextQuestion()" id="next-btn" class="bg-blue-500 text-white px-4 sm:px-6 py-2 sm:py-3 rounded-lg font-medium hover:bg-blue-600 transition-all duration-300 text-sm sm:text-base order-3">
                        C√¢u sau ‚û°Ô∏è
                    </button>
                </div>
            </div>

            <!-- Results -->
            <div id="exam-results" class="hidden card-gradient rounded-xl p-4 sm:p-6 lg:p-8 shadow-2xl bounce-in">
                <div class="text-center">
                    <h2 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-4 sm:mb-6">üéâ K·∫øt qu·∫£ b√†i thi</h2>
                    <div id="result-content">
                        <!-- Results will be shown here -->
                    </div>
                    <button onclick="resetExam()" class="mt-4 sm:mt-6 bg-gradient-to-r from-green-500 to-blue-600 text-white py-3 px-6 rounded-lg font-medium hover:from-green-600 hover:to-blue-700 transition-all duration-300 text-sm sm:text-base w-full sm:w-auto">
                        üîÑ L√†m b√†i m·ªõi
                    </button>
                </div>
            </div>
        </div>

        <!-- Manage Questions Tab -->
        <div id="manage-tab" class="tab-content hidden">
            <!-- Password Protection -->
            <div id="password-form" class="card-gradient rounded-xl p-4 sm:p-6 lg:p-8 shadow-2xl fade-in max-w-md mx-auto">
                <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-4 sm:mb-6 text-center">üîí Nh·∫≠p m·∫≠t kh·∫©u</h2>
                <form onsubmit="checkPassword(event)">
                    <input type="password" id="admin-password" placeholder="M·∫≠t kh·∫©u qu·∫£n tr·ªã" class="w-full px-3 sm:px-4 py-2 sm:py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent mb-4 text-sm sm:text-base">
                    <button type="submit" class="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white py-3 px-6 rounded-lg font-medium hover:from-blue-600 hover:to-purple-700 transition-all duration-300 text-sm sm:text-base">
                        üîì Truy c·∫≠p
                    </button>
                </form>
            </div>

            <!-- Management Interface -->
            <div id="management-interface" class="hidden">
                <!-- Statistics -->
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 sm:gap-6 mb-4 sm:mb-6">
                    <div class="card-gradient rounded-xl p-4 sm:p-6 shadow-xl text-center slide-up">
                        <div class="text-2xl sm:text-3xl font-bold text-blue-600" id="total-questions-stat">0</div>
                        <div class="text-gray-600 text-sm sm:text-base">T·ªïng c√¢u h·ªèi</div>
                    </div>
                    <div class="card-gradient rounded-xl p-4 sm:p-6 shadow-xl text-center slide-up">
                        <div class="text-2xl sm:text-3xl font-bold text-green-600" id="total-students-stat">0</div>
                        <div class="text-gray-600 text-sm sm:text-base">H·ªçc sinh ƒë√£ thi</div>
                    </div>
                    <div class="card-gradient rounded-xl p-4 sm:p-6 shadow-xl text-center slide-up">
                        <div class="text-2xl sm:text-3xl font-bold text-purple-600" id="avg-score-stat">0</div>
                        <div class="text-gray-600 text-sm sm:text-base">ƒêi·ªÉm trung b√¨nh</div>
                    </div>
                </div>

                <!-- Question Management -->
                <div class="card-gradient rounded-xl p-4 sm:p-6 lg:p-8 shadow-2xl fade-in">
                    <!-- Current Question Set Display -->
                    <div class="bg-blue-50 p-3 sm:p-4 rounded-lg mb-4 sm:mb-6 border-l-4 border-blue-500">
                        <div class="text-center">
                            <span class="text-blue-600 font-semibold text-sm sm:text-base">üìö ƒêang qu·∫£n l√Ω b·ªô c√¢u h·ªèi: </span>
                            <span class="text-blue-800 font-bold text-sm sm:text-base" id="manage-question-set-name">ƒêang t·∫£i...</span>
                        </div>
                    </div>
                    
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4 sm:mb-6 gap-4">
                        <h2 class="text-xl sm:text-2xl font-bold text-gray-800">üìö Qu·∫£n l√Ω c√¢u h·ªèi</h2>
                        <div class="grid grid-cols-2 sm:flex sm:flex-wrap gap-2">
                            <button onclick="selectAllQuestions()" class="bg-indigo-500 text-white px-2 sm:px-4 py-2 rounded-lg hover:bg-indigo-600 transition-all duration-300 text-xs sm:text-sm">
                                ‚òëÔ∏è <span class="hidden sm:inline">Ch·ªçn t·∫•t c·∫£</span><span class="sm:hidden">Ch·ªçn</span>
                            </button>
                            <button onclick="deleteSelectedQuestions()" class="bg-red-500 text-white px-2 sm:px-4 py-2 rounded-lg hover:bg-red-600 transition-all duration-300 text-xs sm:text-sm">
                                üóëÔ∏è <span class="hidden sm:inline">X√≥a ƒë√£ ch·ªçn</span><span class="sm:hidden">X√≥a</span>
                            </button>
                            <button onclick="showAddQuestionModal()" class="bg-green-500 text-white px-2 sm:px-4 py-2 rounded-lg hover:bg-green-600 transition-all duration-300 text-xs sm:text-sm">
                                ‚ûï <span class="hidden sm:inline">Th√™m c√¢u h·ªèi</span><span class="sm:hidden">Th√™m</span>
                            </button>
                            <button onclick="showImportModal()" class="bg-blue-500 text-white px-2 sm:px-4 py-2 rounded-lg hover:bg-blue-600 transition-all duration-300 text-xs sm:text-sm">
                                üì• <span class="hidden sm:inline">Import Word</span><span class="sm:hidden">Import</span>
                            </button>
                            <button onclick="exportQuestions()" class="bg-purple-500 text-white px-2 sm:px-4 py-2 rounded-lg hover:bg-purple-600 transition-all duration-300 text-xs sm:text-sm col-span-2 sm:col-span-1">
                                üì§ <span class="hidden sm:inline">Export Word</span><span class="sm:hidden">Export</span>
                            </button>
                        </div>
                    </div>

                    <div id="questions-list" class="space-y-3 sm:space-y-4">
                        <!-- Questions will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Ranking Tab -->
        <div id="ranking-tab" class="tab-content hidden">
            <div class="card-gradient rounded-xl p-4 sm:p-6 lg:p-8 shadow-2xl fade-in">
                <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4 sm:mb-6 gap-4">
                    <h2 class="text-xl sm:text-2xl font-bold text-gray-800">üèÜ B·∫£ng x·∫øp h·∫°ng</h2>
                    <div class="flex gap-2">
                        <button onclick="exportResults()" class="bg-green-500 text-white px-3 sm:px-4 py-2 rounded-lg hover:bg-green-600 transition-all duration-300 text-xs sm:text-sm">
                            üìä <span class="hidden sm:inline">Export Excel</span><span class="sm:hidden">Excel</span>
                        </button>
                        <button onclick="clearAllResults()" class="bg-red-500 text-white px-3 sm:px-4 py-2 rounded-lg hover:bg-red-600 transition-all duration-300 text-xs sm:text-sm">
                            üóëÔ∏è <span class="hidden sm:inline">X√≥a t·∫•t c·∫£</span><span class="sm:hidden">X√≥a</span>
                        </button>
                    </div>
                </div>
                <div id="ranking-list">
                    <!-- Rankings will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Backup & Restore Tab -->
        <div id="backup-tab" class="tab-content hidden">
            <div class="space-y-4 sm:space-y-6">
                <!-- Backup Status -->
                <div class="card-gradient rounded-xl p-4 sm:p-6 lg:p-8 shadow-2xl fade-in">
                    <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-4 sm:mb-6">üìä Tr·∫°ng th√°i h·ªá th·ªëng</h2>
                    
                    <!-- Current Question Set Name -->
                    <div class="bg-blue-50 p-3 sm:p-4 rounded-lg mb-4 sm:mb-6 border-l-4 border-blue-500">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-center sm:space-x-2 text-center">
                            <span class="text-blue-600 font-semibold text-sm sm:text-base">üìö B·ªô c√¢u h·ªèi hi·ªán t·∫°i:</span>
                            <span class="text-blue-800 font-bold text-sm sm:text-base" id="current-question-set-display">ƒêang t·∫£i...</span>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 sm:gap-6">
                        <div class="bg-blue-50 p-3 sm:p-6 rounded-lg text-center">
                            <div class="text-2xl sm:text-3xl font-bold text-blue-600" id="backup-questions-count">0</div>
                            <div class="text-blue-800 text-xs sm:text-base">C√¢u h·ªèi</div>
                        </div>
                        <div class="bg-green-50 p-3 sm:p-6 rounded-lg text-center">
                            <div class="text-2xl sm:text-3xl font-bold text-green-600" id="backup-results-count">0</div>
                            <div class="text-green-800 text-xs sm:text-base">K·∫øt qu·∫£ thi</div>
                        </div>
                        <div class="bg-purple-50 p-3 sm:p-6 rounded-lg text-center">
                            <div class="text-lg sm:text-2xl font-bold text-purple-600" id="backup-size">0 KB</div>
                            <div class="text-purple-800 text-xs sm:text-base">Dung l∆∞·ª£ng</div>
                        </div>
                        <div class="bg-yellow-50 p-3 sm:p-6 rounded-lg text-center">
                            <div class="text-sm sm:text-lg font-bold text-yellow-600" id="last-backup">Ch∆∞a c√≥</div>
                            <div class="text-yellow-800 text-xs sm:text-base">Backup cu·ªëi</div>
                        </div>
                    </div>
                </div>

                <!-- Backup Operations -->
                <div class="card-gradient rounded-xl p-8 shadow-2xl fade-in">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">üíæ Sao l∆∞u d·ªØ li·ªáu</h2>
                    
                    <!-- Manual Backup -->
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">üîß Sao l∆∞u th·ªß c√¥ng</h3>
                        <div class="flex justify-center">
                            <button onclick="createFullBackup()" class="bg-gradient-to-r from-blue-500 to-blue-600 text-white px-8 py-4 rounded-lg hover:from-blue-600 hover:to-blue-700 transition-all duration-300 flex items-center justify-center space-x-2">
                                <span>üîê</span>
                                <span>T·∫°o backup c√≥ m√£ h√≥a</span>
                            </button>
                        </div>
                    </div>




                </div>

                <!-- Restore Operations -->
                <div class="card-gradient rounded-xl p-8 shadow-2xl fade-in">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">üîÑ Ph·ª•c h·ªìi d·ªØ li·ªáu</h2>
                    
                    <!-- File Upload -->
                    <div class="mb-6">
                        <label class="block text-gray-700 font-medium mb-2 text-sm sm:text-base">Ch·ªçn file backup ƒë·ªÉ ph·ª•c h·ªìi:</label>
                        <div class="space-y-3">
                            <input type="file" id="restore-file" accept=".json" class="w-full px-3 sm:px-4 py-2 sm:py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm sm:text-base">
                            <button onclick="analyzeBackupFile()" class="w-full sm:w-auto bg-blue-500 text-white px-4 sm:px-6 py-2 sm:py-3 rounded-lg hover:bg-blue-600 transition-all duration-300 text-sm sm:text-base">
                                üîç Ph√¢n t√≠ch file
                            </button>
                        </div>
                    </div>

                    <!-- Backup Analysis -->
                    <div id="backup-analysis" class="hidden mb-6 p-6 bg-blue-50 rounded-lg">
                        <h4 class="font-bold text-blue-800 mb-4">üìã Th√¥ng tin file backup</h4>
                        <div id="backup-info" class="text-sm text-blue-700 space-y-2">
                            <!-- Backup info will be loaded here -->
                        </div>
                    </div>

                    <!-- Restore Options -->
                    <div id="restore-options" class="hidden mb-6">
                        <h4 class="font-semibold text-gray-700 mb-4">üéØ T√πy ch·ªçn ph·ª•c h·ªìi</h4>
                        <div class="space-y-3">
                            <label class="flex items-center space-x-3">
                                <input type="checkbox" id="restore-questions" checked class="text-blue-600 focus:ring-blue-500">
                                <span class="text-gray-700">Ph·ª•c h·ªìi c√¢u h·ªèi</span>
                            </label>
                            <label class="flex items-center space-x-3">
                                <input type="checkbox" id="restore-results" checked class="text-blue-600 focus:ring-blue-500">
                                <span class="text-gray-700">Ph·ª•c h·ªìi k·∫øt qu·∫£ thi</span>
                            </label>

                        </div>
                    </div>

                    <!-- Restore Actions -->
                    <div id="restore-actions" class="hidden flex space-x-4">
                        <button onclick="performRestore()" class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition-all duration-300">
                            ‚úÖ Th·ª±c hi·ªán ph·ª•c h·ªìi
                        </button>
                        <button onclick="cancelRestore()" class="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition-all duration-300">
                            ‚ùå H·ªßy b·ªè
                        </button>
                    </div>


                </div>


            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Add/Edit Question Modal -->
    <div id="question-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50 flex items-center justify-center p-2 sm:p-4">
        <div class="bg-white rounded-xl p-4 sm:p-6 lg:p-8 max-w-4xl w-full max-h-[95vh] sm:max-h-[90vh] overflow-y-auto bounce-in">
            <div class="flex justify-between items-center mb-4 sm:mb-6">
                <h3 class="text-lg sm:text-xl lg:text-2xl font-bold text-gray-800" id="modal-title">‚ûï Th√™m c√¢u h·ªèi m·ªõi</h3>
                <button onclick="closeQuestionModal()" class="text-gray-500 hover:text-gray-700 text-xl sm:text-2xl">‚úï</button>
            </div>
            
            <form onsubmit="saveQuestion(event)" class="space-y-4 sm:space-y-6">
                <div>
                    <label class="block text-gray-700 font-medium mb-2 text-sm sm:text-base">C√¢u h·ªèi:</label>
                    <textarea id="question-text" required class="w-full px-3 sm:px-4 py-2 sm:py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm sm:text-base" rows="3"></textarea>
                    <div class="mt-2">
                        <label class="block text-xs sm:text-sm text-gray-600 mb-1">H√¨nh ·∫£nh c√¢u h·ªèi (t√πy ch·ªçn):</label>
                        <input type="file" id="question-image" accept="image/*" class="w-full px-2 sm:px-3 py-1 sm:py-2 border border-gray-300 rounded-lg text-xs sm:text-sm">
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4">
                    <div>
                        <label class="block text-gray-700 font-medium mb-2 text-sm sm:text-base">ƒê√°p √°n A:</label>
                        <textarea id="answer-a" required class="w-full px-3 sm:px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm sm:text-base" rows="2"></textarea>
                        <input type="file" accept="image/*" class="mt-1 w-full px-2 py-1 border border-gray-300 rounded text-xs sm:text-sm">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2 text-sm sm:text-base">ƒê√°p √°n B:</label>
                        <textarea id="answer-b" required class="w-full px-3 sm:px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm sm:text-base" rows="2"></textarea>
                        <input type="file" accept="image/*" class="mt-1 w-full px-2 py-1 border border-gray-300 rounded text-xs sm:text-sm">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2 text-sm sm:text-base">ƒê√°p √°n C:</label>
                        <textarea id="answer-c" required class="w-full px-3 sm:px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm sm:text-base" rows="2"></textarea>
                        <input type="file" accept="image/*" class="mt-1 w-full px-2 py-1 border border-gray-300 rounded text-xs sm:text-sm">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2 text-sm sm:text-base">ƒê√°p √°n D:</label>
                        <textarea id="answer-d" required class="w-full px-3 sm:px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm sm:text-base" rows="2"></textarea>
                        <input type="file" accept="image/*" class="mt-1 w-full px-2 py-1 border border-gray-300 rounded text-xs sm:text-sm">
                    </div>
                </div>

                <div>
                    <label class="block text-gray-700 font-medium mb-2 text-sm sm:text-base">ƒê√°p √°n ƒë√∫ng:</label>
                    <select id="correct-answer" required class="w-full px-3 sm:px-4 py-2 sm:py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm sm:text-base">
                        <option value="">Ch·ªçn ƒë√°p √°n ƒë√∫ng</option>
                        <option value="A">A</option>
                        <option value="B">B</option>
                        <option value="C">C</option>
                        <option value="D">D</option>
                    </select>
                </div>

                <div class="flex flex-col sm:flex-row justify-end space-y-2 sm:space-y-0 sm:space-x-4">
                    <button type="button" onclick="closeQuestionModal()" class="px-4 sm:px-6 py-2 sm:py-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition-all duration-300 text-sm sm:text-base">
                        H·ªßy
                    </button>
                    <button type="submit" class="px-4 sm:px-6 py-2 sm:py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-all duration-300 text-sm sm:text-base">
                        üíæ L∆∞u c√¢u h·ªèi
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Import Modal -->
    <div id="import-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl p-8 max-w-4xl w-full max-h-[90vh] overflow-y-auto bounce-in">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-800">üì• Import c√¢u h·ªèi t·ª´ Word</h3>
                <button onclick="closeImportModal()" class="text-gray-500 hover:text-gray-700 text-2xl">‚úï</button>
            </div>
            
            <div class="mb-6">
                <input type="file" id="word-file" accept=".docx" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <button onclick="processWordFile()" class="mt-4 bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 transition-all duration-300">
                    üîÑ X·ª≠ l√Ω file
                </button>
            </div>

            <div class="mb-6 p-4 bg-blue-50 rounded-lg">
                <h4 class="font-bold text-blue-800 mb-2">üìã H∆∞·ªõng d·∫´n format:</h4>
                <div class="text-sm text-blue-700 space-y-2">
                    <p><strong>Format 1:</strong> C√¢u h·ªèi + A. B. C. D. + ƒê√°p √°n: X</p>
                    <p><strong>V√≠ d·ª•:</strong></p>
                    <div class="bg-white p-3 rounded border-l-4 border-blue-500 text-gray-800">
                        <p>C√¢u 1: Microsoft Word l√† ph·∫ßn m·ªÅm g√¨?</p>
                        <p>A. Ph·∫ßn m·ªÅm x·ª≠ l√Ω vƒÉn b·∫£n</p>
                        <p>B. Ph·∫ßn m·ªÅm t√≠nh to√°n</p>
                        <p>C. Ph·∫ßn m·ªÅm tr√¨nh chi·∫øu</p>
                        <p>D. Ph·∫ßn m·ªÅm v·∫Ω</p>
                        <p>ƒê√°p √°n: A</p>
                    </div>
                </div>
            </div>

            <div id="preview-questions" class="hidden">
                <h4 class="font-bold text-gray-800 mb-4">üëÄ Preview c√¢u h·ªèi:</h4>
                <div id="preview-content" class="space-y-4 max-h-96 overflow-y-auto">
                    <!-- Preview content will be loaded here -->
                </div>
                <div class="flex justify-end space-x-4 mt-6">
                    <button onclick="closeImportModal()" class="px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition-all duration-300">
                        H·ªßy
                    </button>
                    <button onclick="confirmImport()" class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-all duration-300">
                        ‚úÖ X√°c nh·∫≠n import
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl p-8 max-w-md w-full bounce-in">
            <div class="text-center">
                <div class="text-6xl mb-4">‚ö†Ô∏è</div>
                <h3 class="text-xl font-bold text-gray-800 mb-4" id="confirm-title">X√°c nh·∫≠n</h3>
                <p class="text-gray-600 mb-6" id="confirm-message">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën th·ª±c hi·ªán h√†nh ƒë·ªông n√†y?</p>
                <div class="flex justify-center space-x-4">
                    <button onclick="closeConfirmModal()" class="px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition-all duration-300">
                        H·ªßy
                    </button>
                    <button onclick="confirmAction()" id="confirm-btn" class="px-6 py-3 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-all duration-300">
                        X√°c nh·∫≠n
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast">
        <div class="bg-white rounded-lg shadow-lg p-3 sm:p-4 flex items-center space-x-2 sm:space-x-3 min-w-64 sm:min-w-80 max-w-sm sm:max-w-md">
            <div id="toast-icon" class="text-xl sm:text-2xl flex-shrink-0"></div>
            <div class="min-w-0 flex-1">
                <div id="toast-title" class="font-medium text-gray-800 text-sm sm:text-base truncate"></div>
                <div id="toast-message" class="text-xs sm:text-sm text-gray-600 break-words"></div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let questions = [];
        let shuffledQuestions = [];
        let currentQuestionIndex = 0;
        let studentAnswers = {};
        let examTimer = null;
        let elapsedTimer = null;
        let elapsedTime = 0;
        let currentEditingIndex = -1;
        let previewQuestions = [];
        let confirmCallback = null;
        let backupData = null;
        let currentQuestionSetName = 'B·ªô c√¢u h·ªèi m·∫∑c ƒë·ªãnh';

        // Simple encryption/decryption functions
        function encryptData(data, password) {
            try {
                const key = createStrongKey(password);
                const salt = generateSalt();
                const saltedData = salt + data;
                
                let encrypted = '';
                for (let i = 0; i < saltedData.length; i++) {
                    const dataChar = saltedData.charCodeAt(i);
                    const keyChar = key.charCodeAt(i % key.length);
                    const encryptedChar = dataChar ^ keyChar;
                    encrypted += String.fromCharCode(encryptedChar);
                }
                
                return btoa(unescape(encodeURIComponent(encrypted)));
            } catch (error) {
                console.error('Encryption error:', error);
                throw new Error('L·ªói m√£ h√≥a d·ªØ li·ªáu: ' + error.message);
            }
        }

        function decryptData(encryptedData, password) {
            try {
                const encrypted = decodeURIComponent(escape(atob(encryptedData)));
                const key = createStrongKey(password);
                
                let decrypted = '';
                for (let i = 0; i < encrypted.length; i++) {
                    const encryptedChar = encrypted.charCodeAt(i);
                    const keyChar = key.charCodeAt(i % key.length);
                    const decryptedChar = encryptedChar ^ keyChar;
                    decrypted += String.fromCharCode(decryptedChar);
                }
                
                const originalData = decrypted.substring(16);
                JSON.parse(originalData);
                
                return originalData;
            } catch (error) {
                console.error('Decryption error:', error);
                throw new Error('L·ªói gi·∫£i m√£ d·ªØ li·ªáu - m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng ho·∫∑c file b·ªã l·ªói');
            }
        }

        function createStrongKey(password) {
            let key = '';
            const multipliers = [7, 11, 13, 17, 19, 23];
            
            for (let i = 0; i < password.length; i++) {
                const char = password.charCodeAt(i);
                const multiplier = multipliers[i % multipliers.length];
                const hashedChar = ((char * multiplier) + (i * 31)) % 256;
                key += String.fromCharCode(hashedChar);
            }
            
            while (key.length < 64) {
                key += key;
            }
            
            return key.substring(0, 128);
        }

        function generateSalt() {
            let salt = '';
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            for (let i = 0; i < 16; i++) {
                salt += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return salt;
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeDatabase();
            updateStatistics();
            loadQuestionsList();
            loadRankings();
            loadBackupStatus();
            updateQuestionSetDisplay();
        });

        // Update question set name display
        function updateQuestionSetDisplay() {
            const examDisplay = document.getElementById('exam-question-set-name');
            const backupDisplay = document.getElementById('current-question-set-display');
            const manageDisplay = document.getElementById('manage-question-set-name');
            
            if (examDisplay) {
                examDisplay.textContent = currentQuestionSetName;
            }
            if (backupDisplay) {
                backupDisplay.textContent = currentQuestionSetName;
            }
            if (manageDisplay) {
                manageDisplay.textContent = currentQuestionSetName;
            }
        }

        // Backup & Restore Functions
        function loadBackupStatus() {
            const questionsCount = questions.length;
            const results = JSON.parse(localStorage.getItem('quiz-results') || '[]');
            const resultsCount = results.length;
            
            // Calculate approximate size
            const dataSize = JSON.stringify({questions, results}).length;
            const sizeKB = Math.round(dataSize / 1024 * 100) / 100;
            
            // Get last backup time
            const lastBackup = localStorage.getItem('last-backup-time');
            const lastBackupText = lastBackup ? 
                new Date(lastBackup).toLocaleString('vi-VN') : 'Ch∆∞a c√≥';
            
            document.getElementById('backup-questions-count').textContent = questionsCount;
            document.getElementById('backup-results-count').textContent = resultsCount;
            document.getElementById('backup-size').textContent = sizeKB + ' KB';
            document.getElementById('last-backup').textContent = lastBackupText;
            
            // Update question set display
            updateQuestionSetDisplay();
        }



        function createFullBackup() {
            const questionSetName = prompt('üìö Nh·∫≠p t√™n cho b·ªô c√¢u h·ªèi:\n(V√≠ d·ª•: To√°n l·ªõp 9, VƒÉn h·ªçc l·ªõp 10...)');
            if (!questionSetName || questionSetName.trim() === '') {
                if (questionSetName !== null) {
                    showToast('‚ùå', 'L·ªói', 'Vui l√≤ng nh·∫≠p t√™n b·ªô c√¢u h·ªèi!', 'error');
                }
                return;
            }
            
            const password = prompt('üîê Nh·∫≠p m·∫≠t kh·∫©u ƒë·ªÉ m√£ h√≥a backup:\n(T·ªëi thi·ªÉu 4 k√Ω t·ª±)');
            if (!password || password.length < 4) {
                if (password !== null) {
                    showToast('‚ùå', 'L·ªói', 'M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 4 k√Ω t·ª±!', 'error');
                }
                return;
            }
            
            try {
                const backupData = createBackupData(questionSetName.trim());
                const dataStr = JSON.stringify(backupData, null, 2);
                const encryptedData = encryptData(dataStr, password);
                
                const finalData = {
                    encrypted: true,
                    data: encryptedData,
                    timestamp: new Date().toISOString(),
                    version: '1.0',
                    type: 'manual-encrypted',
                    questionSetName: questionSetName.trim()
                };
                
                const fileName = `${questionSetName.trim().replace(/[^a-zA-Z0-9\s]/g, '').replace(/\s+/g, '-')}-${new Date().toISOString().split('T')[0]}.json`;
                downloadBackup(finalData, fileName);
                localStorage.setItem('last-backup-time', new Date().toISOString());
                loadBackupStatus();
                showToast('üîê', 'Th√†nh c√¥ng', 'ƒê√£ t·∫°o backup c√≥ m√£ h√≥a!', 'success');
            } catch (error) {
                showToast('‚ùå', 'L·ªói', 'Kh√¥ng th·ªÉ t·∫°o backup: ' + error.message, 'error');
            }
        }





        function createBackupData(questionSetName = 'B·ªô c√¢u h·ªèi m·∫∑c ƒë·ªãnh') {
            const results = JSON.parse(localStorage.getItem('quiz-results') || '[]');
            return {
                questions: questions,
                results: results,
                questionSetName: questionSetName,
                metadata: {
                    exportDate: new Date().toISOString(),
                    totalQuestions: questions.length,
                    totalResults: results.length,
                    version: '1.0',
                    appName: 'Quiz Management System',
                    questionSetName: questionSetName
                }
            };
        }



        function downloadBackup(data, filename) {
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json;charset=utf-8' });
            
            const link = document.createElement('a');
            const url = URL.createObjectURL(dataBlob);
            link.href = url;
            link.download = filename;
            link.style.display = 'none';
            
            document.body.appendChild(link);
            link.click();
            
            setTimeout(() => {
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }, 100);
        }

        function analyzeBackupFile() {
            const fileInput = document.getElementById('restore-file');
            const file = fileInput.files[0];
            
            if (!file) {
                showToast('‚ö†Ô∏è', 'C·∫£nh b√°o', 'Vui l√≤ng ch·ªçn file backup!', 'warning');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const fileContent = JSON.parse(e.target.result);
                    
                    if (fileContent.encrypted === true) {
                        const password = prompt('üîê File backup ƒë∆∞·ª£c m√£ h√≥a!\nNh·∫≠p m·∫≠t kh·∫©u ƒë·ªÉ gi·∫£i m√£:');
                        if (!password) {
                            showToast('‚ö†Ô∏è', 'H·ªßy b·ªè', 'ƒê√£ h·ªßy gi·∫£i m√£ file!', 'warning');
                            return;
                        }
                        
                        try {
                            const decryptedData = decryptData(fileContent.data, password);
                            backupData = JSON.parse(decryptedData);
                        } catch (decryptError) {
                            showToast('‚ùå', 'L·ªói', 'M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng ho·∫∑c file b·ªã l·ªói!', 'error');
                            return;
                        }
                    } else {
                        backupData = fileContent;
                    }
                    
                    if (!backupData.questions && !backupData.results) {
                        throw new Error('File backup kh√¥ng h·ª£p l·ªá');
                    }
                    
                    showBackupAnalysis(fileContent, backupData);
                    
                } catch (error) {
                    showToast('‚ùå', 'L·ªói', 'File backup kh√¥ng h·ª£p l·ªá!', 'error');
                }
            };
            reader.readAsText(file);
        }

        function showBackupAnalysis(fileContent, data) {
            const isEncrypted = fileContent.encrypted === true;
            const questionsCount = data.questions ? data.questions.length : 0;
            const resultsCount = data.results ? data.results.length : 0;
            const questionSetName = data.questionSetName || data.metadata?.questionSetName || 'Kh√¥ng r√µ';
            
            const info = `
                <div class="grid grid-cols-2 gap-4">
                    <div><strong>üìö T√™n b·ªô c√¢u h·ªèi:</strong> ${questionSetName}</div>
                    <div><strong>üîê Tr·∫°ng th√°i:</strong> ${isEncrypted ? 'üîí ƒê√£ m√£ h√≥a' : 'üîì Kh√¥ng m√£ h√≥a'}</div>
                    <div><strong>üìÖ Ng√†y t·∫°o:</strong> ${data.metadata?.exportDate ? new Date(data.metadata.exportDate).toLocaleString('vi-VN') : 'Kh√¥ng r√µ'}</div>
                    <div><strong>üìö C√¢u h·ªèi:</strong> ${questionsCount}</div>
                    <div><strong>üìä K·∫øt qu·∫£:</strong> ${resultsCount}</div>
                    <div><strong>üè∑Ô∏è Phi√™n b·∫£n:</strong> ${data.metadata?.version || 'Kh√¥ng r√µ'}</div>
                </div>
            `;
            
            document.getElementById('backup-info').innerHTML = info;
            document.getElementById('backup-analysis').classList.remove('hidden');
            document.getElementById('restore-options').classList.remove('hidden');
            document.getElementById('restore-actions').classList.remove('hidden');
            
            // Set default options
            document.getElementById('restore-questions').checked = questionsCount > 0;
            document.getElementById('restore-results').checked = resultsCount > 0;
            
            showToast('‚úÖ', 'Th√†nh c√¥ng', 'File backup h·ª£p l·ªá!', 'success');
        }

        function performRestore() {
            if (!backupData) {
                showToast('‚ùå', 'L·ªói', 'Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ ph·ª•c h·ªìi!', 'error');
                return;
            }
            
            const restoreQuestions = document.getElementById('restore-questions').checked;
            const restoreResults = document.getElementById('restore-results').checked;
            
            if (!restoreQuestions && !restoreResults) {
                showToast('‚ö†Ô∏è', 'C·∫£nh b√°o', 'Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt m·ª•c ƒë·ªÉ ph·ª•c h·ªìi!', 'warning');
                return;
            }
            
            showConfirmModal(
                'üîÑ X√°c nh·∫≠n ph·ª•c h·ªìi',
                'B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ph·ª•c h·ªìi d·ªØ li·ªáu? D·ªØ li·ªáu hi·ªán t·∫°i s·∫Ω b·ªã ghi ƒë√®.',
                () => {
                    try {
                        // Skip backup current data to avoid download dialog
                        
                        // Restore questions
                        if (restoreQuestions && backupData.questions) {
                            questions = backupData.questions;
                            currentQuestionSetName = backupData.questionSetName || backupData.metadata?.questionSetName || 'B·ªô c√¢u h·ªèi ƒë∆∞·ª£c ph·ª•c h·ªìi';
                            localStorage.setItem('quiz-questions', JSON.stringify(questions));
                            localStorage.setItem('current-question-set-name', currentQuestionSetName);
                        }
                        
                        // Restore results
                        if (restoreResults && backupData.results) {
                            localStorage.setItem('quiz-results', JSON.stringify(backupData.results));
                        }
                        
                        // Update UI
                        loadQuestionsList();
                        loadRankings();
                        updateStatistics();
                        loadBackupStatus();
                        updateQuestionSetDisplay();
                        
                        cancelRestore();
                        showToast('üéâ', 'Th√†nh c√¥ng', 'ƒê√£ ph·ª•c h·ªìi d·ªØ li·ªáu th√†nh c√¥ng!', 'success');
                        
                    } catch (error) {
                        showToast('‚ùå', 'L·ªói', 'Kh√¥ng th·ªÉ ph·ª•c h·ªìi: ' + error.message, 'error');
                    }
                }
            );
        }

        function cancelRestore() {
            document.getElementById('restore-file').value = '';
            document.getElementById('backup-analysis').classList.add('hidden');
            document.getElementById('restore-options').classList.add('hidden');
            document.getElementById('restore-actions').classList.add('hidden');
            backupData = null;
        }





        // Shuffle array function
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // Shuffle answers within a question
        function shuffleAnswers(question) {
            const answers = Object.entries(question.answers);
            const shuffledAnswers = shuffleArray(answers);
            const answerKeys = ['A', 'B', 'C', 'D'];
            
            const newAnswers = {};
            let newCorrect = '';
            
            shuffledAnswers.forEach(([oldKey, value], index) => {
                const newKey = answerKeys[index];
                newAnswers[newKey] = value;
                if (oldKey === question.correct) {
                    newCorrect = newKey;
                }
            });
            
            return {
                ...question,
                answers: newAnswers,
                correct: newCorrect
            };
        }

        // Database Management System
        function initializeDatabase() {
            const existingQuestions = localStorage.getItem('quiz-questions');
            const savedQuestionSetName = localStorage.getItem('current-question-set-name');
            
            if (savedQuestionSetName) {
                currentQuestionSetName = savedQuestionSetName;
            }
            
            if (!existingQuestions) {
                loadDefaultQuestions();
                showToast('üóÑÔ∏è', 'Database', 'ƒê√£ kh·ªüi t·∫°o c∆° s·ªü d·ªØ li·ªáu m·ªõi!', 'info');
            } else {
                questions = JSON.parse(existingQuestions);
                if (questions.length > 0) {
                    showToast('üìÇ', 'Database', `ƒê√£ t·∫£i ${questions.length} c√¢u h·ªèi t·ª´ "${currentQuestionSetName}"!`, 'success');
                }
            }
        }

        function saveToDatabase() {
            try {
                localStorage.setItem('quiz-questions', JSON.stringify(questions));
                localStorage.setItem('current-question-set-name', currentQuestionSetName);
                
                const metadata = {
                    lastUpdated: new Date().toISOString(),
                    totalQuestions: questions.length,
                    version: '1.0'
                };
                localStorage.setItem('quiz-metadata', JSON.stringify(metadata));
                
                return true;
            } catch (error) {
                console.error('L·ªói l∆∞u database:', error);
                showToast('‚ùå', 'L·ªói', 'Kh√¥ng th·ªÉ l∆∞u v√†o c∆° s·ªü d·ªØ li·ªáu!', 'error');
                return false;
            }
        }

        function loadDefaultQuestions() {
            if (!localStorage.getItem('quiz-questions')) {
                localStorage.setItem('quiz-questions', JSON.stringify([]));
            }
            questions = JSON.parse(localStorage.getItem('quiz-questions') || '[]');
        }

        // Tab switching
        function switchTab(tabName) {
            if (tabName === 'manage' && !sessionStorage.getItem('admin-authenticated')) {
                document.getElementById('admin-password').value = '';
                document.getElementById('password-form').classList.remove('hidden');
                document.getElementById('management-interface').classList.add('hidden');
            }
            
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active', 'bg-white', 'text-blue-600', 'shadow-lg');
                btn.classList.add('text-white/80', 'hover:text-white', 'hover:bg-white/10');
            });
            
            document.getElementById(tabName + '-tab').classList.remove('hidden');
            
            const activeBtn = document.getElementById('tab-' + tabName);
            activeBtn.classList.add('active', 'bg-white', 'text-blue-600', 'shadow-lg');
            activeBtn.classList.remove('text-white/80', 'hover:text-white', 'hover:bg-white/10');
            
            if (tabName === 'manage') {
                updateStatistics();
                loadQuestionsList();
            } else if (tabName === 'ranking') {
                loadRankings();
            } else if (tabName === 'backup') {
                loadBackupStatus();
            } else if (tabName === 'exam') {
                updateQuestionSetDisplay();
            }
        }

        // Exam functions
        function startExam(event) {
            event.preventDefault();
            
            if (questions.length === 0) {
                showToast('‚ö†Ô∏è', 'C·∫£nh b√°o', 'Ch∆∞a c√≥ c√¢u h·ªèi n√†o ƒë·ªÉ thi!', 'warning');
                return;
            }
            
            const name = document.getElementById('student-name').value;
            const studentClass = document.getElementById('student-class').value;
            
            sessionStorage.setItem('student-info', JSON.stringify({
                name, class: studentClass
            }));
            
            shuffledQuestions = shuffleArray(questions).map(question => shuffleAnswers(question));
            
            currentQuestionIndex = 0;
            studentAnswers = {};
            elapsedTime = 0;
            
            document.getElementById('student-form').classList.add('hidden');
            document.getElementById('exam-interface').classList.remove('hidden');
            
            loadQuestion();
            startElapsedTimer();
            
            showToast('üöÄ', 'B·∫Øt ƒë·∫ßu', 'Ch√∫c b·∫°n l√†m b√†i t·ªët!', 'success');
        }

        function loadQuestion() {
            if (shuffledQuestions.length === 0) return;
            
            const question = shuffledQuestions[currentQuestionIndex];
            const questionHtml = `
                <div class="mb-4 sm:mb-6">
                    <h3 class="text-lg sm:text-xl font-bold text-gray-800 mb-3 sm:mb-4 leading-tight">
                        C√¢u ${currentQuestionIndex + 1}: ${question.question}
                    </h3>
                    ${question.questionImage ? `<img src="${question.questionImage}" alt="H√¨nh c√¢u h·ªèi" class="max-w-full h-auto mb-3 sm:mb-4 rounded-lg shadow-md">` : ''}
                </div>
                <div class="space-y-2 sm:space-y-3">
                    ${Object.entries(question.answers).map(([key, value]) => `
                        <label class="flex items-start space-x-2 sm:space-x-3 p-3 sm:p-4 border border-gray-200 rounded-lg hover:bg-blue-50 cursor-pointer transition-all duration-300">
                            <input type="radio" name="answer" value="${key}" ${studentAnswers[currentQuestionIndex] === key ? 'checked' : ''} 
                                   onchange="saveAnswer('${key}')" class="mt-1 text-blue-600 focus:ring-blue-500 flex-shrink-0">
                            <div class="flex-1 min-w-0">
                                <span class="font-medium text-gray-800 text-sm sm:text-base">${key}.</span>
                                <span class="text-gray-700 ml-1 sm:ml-2 text-sm sm:text-base break-words">${typeof value === 'object' ? value.text : value}</span>
                                ${typeof value === 'object' && value.image ? `<img src="${value.image}" alt="H√¨nh ƒë√°p √°n ${key}" class="max-w-full h-auto mt-2 rounded-lg shadow-sm">` : ''}
                            </div>
                        </label>
                    `).join('')}
                </div>
            `;
            
            document.getElementById('question-content').innerHTML = questionHtml;
            document.getElementById('current-question').textContent = currentQuestionIndex + 1;
            document.getElementById('total-questions').textContent = shuffledQuestions.length;
            
            const progress = ((currentQuestionIndex + 1) / shuffledQuestions.length) * 100;
            document.getElementById('progress-bar').style.width = progress + '%';
            
            document.getElementById('prev-btn').disabled = currentQuestionIndex === 0;
            document.getElementById('next-btn').textContent = 
                currentQuestionIndex === shuffledQuestions.length - 1 ? 'Ho√†n th√†nh ‚úÖ' : 'C√¢u sau ‚û°Ô∏è';
        }

        function saveAnswer(answer) {
            studentAnswers[currentQuestionIndex] = answer;
        }

        function nextQuestion() {
            if (currentQuestionIndex < shuffledQuestions.length - 1) {
                currentQuestionIndex++;
                loadQuestion();
            } else {
                submitExam();
            }
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                loadQuestion();
            }
        }

        function startElapsedTimer() {
            elapsedTimer = setInterval(() => {
                elapsedTime++;
                updateElapsedTimeDisplay();
            }, 1000);
        }

        function updateElapsedTimeDisplay() {
            const minutes = Math.floor(elapsedTime / 60);
            const seconds = elapsedTime % 60;
            document.getElementById('elapsed-time').textContent = 
                `‚è±Ô∏è ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function submitExam() {
            showConfirmModal(
                'üì§ N·ªôp b√†i thi',
                'B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën n·ªôp b√†i?',
                () => {
                    clearInterval(elapsedTimer);
                    calculateResults();
                }
            );
        }

        function calculateResults() {
            const studentInfo = JSON.parse(sessionStorage.getItem('student-info'));
            let correctAnswers = 0;
            const totalQuestions = shuffledQuestions.length;
            
            shuffledQuestions.forEach((question, index) => {
                if (studentAnswers[index] === question.correct) {
                    correctAnswers++;
                }
            });
            
            const score = Math.round((correctAnswers / totalQuestions) * 10 * 100) / 100;
            
            const result = {
                ...studentInfo,
                score: score,
                correctAnswers: correctAnswers,
                totalQuestions: totalQuestions,
                timeSpent: elapsedTime,
                timestamp: new Date().toISOString(),
                examDate: new Date().toLocaleDateString('vi-VN'),
                examTime: new Date().toLocaleTimeString('vi-VN'),
                questionSetName: currentQuestionSetName,
                answers: studentAnswers
            };
            
            const results = JSON.parse(localStorage.getItem('quiz-results') || '[]');
            results.push(result);
            localStorage.setItem('quiz-results', JSON.stringify(results));
            
            showResults(result);
        }

        function showResults(result) {
            const percentage = Math.round((result.correctAnswers / result.totalQuestions) * 100);
            let grade = '';
            let gradeColor = '';
            
            if (percentage >= 90) {
                grade = 'Xu·∫•t s·∫Øc';
                gradeColor = 'text-green-600';
            } else if (percentage >= 80) {
                grade = 'Gi·ªèi';
                gradeColor = 'text-blue-600';
            } else if (percentage >= 70) {
                grade = 'Kh√°';
                gradeColor = 'text-yellow-600';
            } else if (percentage >= 50) {
                grade = 'Trung b√¨nh';
                gradeColor = 'text-orange-600';
            } else {
                grade = 'Y·∫øu';
                gradeColor = 'text-red-600';
            }
            
            const timeSpentMinutes = Math.floor(result.timeSpent / 60);
            const timeSpentSeconds = result.timeSpent % 60;
            
            document.getElementById('result-content').innerHTML = `
                <div class="space-y-4 sm:space-y-6">
                    <div class="text-4xl sm:text-6xl mb-3 sm:mb-4">
                        ${percentage >= 80 ? 'üéâ' : percentage >= 50 ? 'üëç' : 'üòî'}
                    </div>
                    
                    <!-- Th√¥ng tin b√†i thi -->
                    <div class="bg-gray-50 p-3 sm:p-4 rounded-lg mb-4 sm:mb-6">
                        <h4 class="font-bold text-gray-800 mb-2 sm:mb-3 text-sm sm:text-base">üìã Th√¥ng tin b√†i thi</h4>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 sm:gap-3 text-xs sm:text-sm">
                            <div><strong>üìö B·ªô c√¢u h·ªèi:</strong> ${result.questionSetName}</div>
                            <div><strong>üìÖ Ng√†y thi:</strong> ${result.examDate}</div>
                            <div><strong>üïê Gi·ªù thi:</strong> ${result.examTime}</div>
                            <div><strong>üë§ H·ªçc sinh:</strong> ${result.name} - ${result.class}</div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-6">
                        <div class="bg-blue-50 p-3 sm:p-6 rounded-lg text-center">
                            <div class="text-2xl sm:text-3xl font-bold text-blue-600">${result.score}</div>
                            <div class="text-blue-800 text-xs sm:text-base">ƒêi·ªÉm s·ªë</div>
                        </div>
                        <div class="bg-green-50 p-3 sm:p-6 rounded-lg text-center">
                            <div class="text-2xl sm:text-3xl font-bold text-green-600">${result.correctAnswers}/${result.totalQuestions}</div>
                            <div class="text-green-800 text-xs sm:text-base">C√¢u ƒë√∫ng</div>
                        </div>
                        <div class="bg-purple-50 p-3 sm:p-6 rounded-lg text-center">
                            <div class="text-lg sm:text-2xl font-bold ${gradeColor}">${grade}</div>
                            <div class="text-purple-800 text-xs sm:text-base">X·∫øp lo·∫°i</div>
                        </div>
                        <div class="bg-yellow-50 p-3 sm:p-6 rounded-lg text-center">
                            <div class="text-lg sm:text-2xl font-bold text-yellow-600">${timeSpentMinutes}:${timeSpentSeconds.toString().padStart(2, '0')}</div>
                            <div class="text-yellow-800 text-xs sm:text-base">Th·ªùi gian</div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('exam-interface').classList.add('hidden');
            document.getElementById('exam-results').classList.remove('hidden');
            
            showToast('üéâ', 'Ho√†n th√†nh', `B·∫°n ƒë√£ ƒë·∫°t ${result.score} ƒëi·ªÉm!`, 'success');
        }

        function resetExam() {
            document.getElementById('exam-results').classList.add('hidden');
            document.getElementById('student-form').classList.remove('hidden');
            
            document.getElementById('student-name').value = '';
            document.getElementById('student-class').value = '';
            
            shuffledQuestions = [];
            sessionStorage.removeItem('student-info');
        }

        // Management functions
        function checkPassword(event) {
            event.preventDefault();
            const password = document.getElementById('admin-password').value;
            
            if (password === 'abc123') {
                sessionStorage.setItem('admin-authenticated', 'true');
                document.getElementById('password-form').classList.add('hidden');
                document.getElementById('management-interface').classList.remove('hidden');
                updateStatistics();
                loadQuestionsList();
                showToast('üîì', 'Th√†nh c√¥ng', 'ƒêƒÉng nh·∫≠p th√†nh c√¥ng!', 'success');
            } else {
                showToast('‚ùå', 'L·ªói', 'M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng!', 'error');
            }
        }

        function updateStatistics() {
            const results = JSON.parse(localStorage.getItem('quiz-results') || '[]');
            const totalQuestions = questions.length;
            const totalStudents = results.length;
            const avgScore = results.length > 0 ? 
                Math.round(results.reduce((sum, result) => sum + result.score, 0) / results.length * 100) / 100 : 0;
            
            document.getElementById('total-questions-stat').textContent = totalQuestions;
            document.getElementById('total-students-stat').textContent = totalStudents;
            document.getElementById('avg-score-stat').textContent = avgScore;
        }

        function loadQuestionsList() {
            const questionsHtml = questions.map((question, index) => `
                <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-all duration-300">
                    <div class="flex items-start space-x-4">
                        <input type="checkbox" class="question-checkbox mt-1" data-index="${index}">
                        <div class="flex-1">
                            <div class="font-medium text-gray-800 mb-2">
                                C√¢u ${index + 1}: ${question.question}
                            </div>
                            ${question.questionImage ? `<img src="${question.questionImage}" alt="H√¨nh c√¢u h·ªèi" class="max-w-xs h-auto mb-3 rounded-lg shadow-sm">` : ''}
                            <div class="text-sm text-gray-600 space-y-2">
                                <div>A. ${typeof question.answers.A === 'object' ? question.answers.A.text : question.answers.A}</div>
                                <div>B. ${typeof question.answers.B === 'object' ? question.answers.B.text : question.answers.B}</div>
                                <div>C. ${typeof question.answers.C === 'object' ? question.answers.C.text : question.answers.C}</div>
                                <div>D. ${typeof question.answers.D === 'object' ? question.answers.D.text : question.answers.D}</div>
                                <div class="font-medium text-green-600">ƒê√°p √°n: ${question.correct}</div>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="editQuestion(${index})" class="text-blue-500 hover:text-blue-700 p-2">‚úèÔ∏è</button>
                            <button onclick="deleteQuestion(${index})" class="text-red-500 hover:text-red-700 p-2">üóëÔ∏è</button>
                        </div>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('questions-list').innerHTML = questionsHtml || 
                '<div class="text-center text-gray-500 py-8">Ch∆∞a c√≥ c√¢u h·ªèi n√†o</div>';
        }

        function selectAllQuestions() {
            const checkboxes = document.querySelectorAll('.question-checkbox');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            
            checkboxes.forEach(cb => {
                cb.checked = !allChecked;
            });
            
            showToast('‚òëÔ∏è', 'Th√†nh c√¥ng', allChecked ? 'ƒê√£ b·ªè ch·ªçn t·∫•t c·∫£' : 'ƒê√£ ch·ªçn t·∫•t c·∫£', 'info');
        }

        function showAddQuestionModal() {
            currentEditingIndex = -1;
            document.getElementById('modal-title').textContent = '‚ûï Th√™m c√¢u h·ªèi m·ªõi';
            clearQuestionForm();
            document.getElementById('question-modal').classList.remove('hidden');
        }

        function editQuestion(index) {
            currentEditingIndex = index;
            const question = questions[index];
            
            document.getElementById('modal-title').textContent = '‚úèÔ∏è Ch·ªânh s·ª≠a c√¢u h·ªèi';
            document.getElementById('question-text').value = question.question;
            
            document.getElementById('answer-a').value = typeof question.answers.A === 'object' ? question.answers.A.text : question.answers.A;
            document.getElementById('answer-b').value = typeof question.answers.B === 'object' ? question.answers.B.text : question.answers.B;
            document.getElementById('answer-c').value = typeof question.answers.C === 'object' ? question.answers.C.text : question.answers.C;
            document.getElementById('answer-d').value = typeof question.answers.D === 'object' ? question.answers.D.text : question.answers.D;
            
            document.getElementById('correct-answer').value = question.correct;
            
            document.getElementById('question-modal').classList.remove('hidden');
        }

        function saveQuestion(event) {
            event.preventDefault();
            
            const questionImageFile = document.getElementById('question-image').files[0];
            let questionImageData = null;
            
            const answerImageFiles = [
                document.querySelector('#answer-a').parentNode.querySelector('input[type="file"]').files[0],
                document.querySelector('#answer-b').parentNode.querySelector('input[type="file"]').files[0],
                document.querySelector('#answer-c').parentNode.querySelector('input[type="file"]').files[0],
                document.querySelector('#answer-d').parentNode.querySelector('input[type="file"]').files[0]
            ];
            
            const processImages = async () => {
                if (questionImageFile) {
                    questionImageData = await fileToBase64(questionImageFile);
                }
                
                const answerImages = await Promise.all(
                    answerImageFiles.map(file => file ? fileToBase64(file) : null)
                );
                
                const questionData = {
                    question: document.getElementById('question-text').value,
                    questionImage: questionImageData,
                    answers: {
                        A: answerImages[0] ? { text: document.getElementById('answer-a').value, image: answerImages[0] } : document.getElementById('answer-a').value,
                        B: answerImages[1] ? { text: document.getElementById('answer-b').value, image: answerImages[1] } : document.getElementById('answer-b').value,
                        C: answerImages[2] ? { text: document.getElementById('answer-c').value, image: answerImages[2] } : document.getElementById('answer-c').value,
                        D: answerImages[3] ? { text: document.getElementById('answer-d').value, image: answerImages[3] } : document.getElementById('answer-d').value
                    },
                    correct: document.getElementById('correct-answer').value
                };
                
                if (currentEditingIndex === -1) {
                    questions.push(questionData);
                    showToast('‚úÖ', 'Th√†nh c√¥ng', 'ƒê√£ th√™m c√¢u h·ªèi m·ªõi!', 'success');
                } else {
                    questions[currentEditingIndex] = questionData;
                    showToast('‚úÖ', 'Th√†nh c√¥ng', 'ƒê√£ c·∫≠p nh·∫≠t c√¢u h·ªèi!', 'success');
                }
                
                if (saveToDatabase()) {
                    closeQuestionModal();
                    loadQuestionsList();
                    updateStatistics();
                    updateQuestionSetDisplay();
                }
            };
            
            processImages();
        }
        
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        function deleteQuestion(index) {
            showConfirmModal(
                'üóëÔ∏è X√≥a c√¢u h·ªèi',
                `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a c√¢u h·ªèi ${index + 1}?`,
                () => {
                    questions.splice(index, 1);
                    if (saveToDatabase()) {
                        loadQuestionsList();
                        updateStatistics();
                        updateQuestionSetDisplay();
                        showToast('‚úÖ', 'Th√†nh c√¥ng', 'ƒê√£ x√≥a c√¢u h·ªèi!', 'success');
                    }
                }
            );
        }

        function deleteSelectedQuestions() {
            const checkboxes = document.querySelectorAll('.question-checkbox:checked');
            if (checkboxes.length === 0) {
                showToast('‚ö†Ô∏è', 'C·∫£nh b√°o', 'Vui l√≤ng ch·ªçn c√¢u h·ªèi c·∫ßn x√≥a!', 'warning');
                return;
            }
            
            showConfirmModal(
                'üóëÔ∏è X√≥a c√¢u h·ªèi',
                `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ${checkboxes.length} c√¢u h·ªèi?`,
                () => {
                    const indices = Array.from(checkboxes).map(cb => parseInt(cb.dataset.index)).sort((a, b) => b - a);
                    indices.forEach(index => questions.splice(index, 1));
                    if (saveToDatabase()) {
                        loadQuestionsList();
                        updateStatistics();
                        updateQuestionSetDisplay();
                        showToast('‚úÖ', 'Th√†nh c√¥ng', `ƒê√£ x√≥a ${indices.length} c√¢u h·ªèi!`, 'success');
                    }
                }
            );
        }

        function clearQuestionForm() {
            document.getElementById('question-text').value = '';
            document.getElementById('answer-a').value = '';
            document.getElementById('answer-b').value = '';
            document.getElementById('answer-c').value = '';
            document.getElementById('answer-d').value = '';
            document.getElementById('correct-answer').value = '';
        }

        function closeQuestionModal() {
            document.getElementById('question-modal').classList.add('hidden');
        }

        // Import/Export functions
        function showImportModal() {
            document.getElementById('import-modal').classList.remove('hidden');
            document.getElementById('preview-questions').classList.add('hidden');
        }

        function closeImportModal() {
            document.getElementById('import-modal').classList.add('hidden');
            document.getElementById('word-file').value = '';
            previewQuestions = [];
        }

        function processWordFile() {
            const fileInput = document.getElementById('word-file');
            const file = fileInput.files[0];
            
            if (!file) {
                showToast('‚ö†Ô∏è', 'C·∫£nh b√°o', 'Vui l√≤ng ch·ªçn file Word!', 'warning');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                mammoth.extractRawText({arrayBuffer: e.target.result})
                    .then(function(result) {
                        parseWordContent(result.value);
                    })
                    .catch(function(err) {
                        showToast('‚ùå', 'L·ªói', 'Kh√¥ng th·ªÉ ƒë·ªçc file Word!', 'error');
                    });
            };
            reader.readAsArrayBuffer(file);
        }

        function parseWordContent(text) {
            previewQuestions = [];
            const lines = text.split('\n').map(line => line.trim()).filter(line => line);
            
            let currentQuestion = null;
            let currentAnswers = {};
            let currentCorrect = '';
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                
                if (line.match(/^(C√¢u|Question)\s*\d+/i) || line.match(/^\d+[\.\)]/)) {
                    if (currentQuestion && Object.keys(currentAnswers).length === 4 && currentCorrect) {
                        previewQuestions.push({
                            question: currentQuestion,
                            answers: currentAnswers,
                            correct: currentCorrect
                        });
                    }
                    
                    currentQuestion = line.replace(/^(C√¢u|Question)\s*\d+[\:\.\)]\s*/i, '');
                    currentAnswers = {};
                    currentCorrect = '';
                }
                else if (line.match(/^[ABCD][\.\)]/i)) {
                    const match = line.match(/^([ABCD])[\.\)]\s*(.+)/i);
                    if (match) {
                        currentAnswers[match[1].toUpperCase()] = match[2];
                    }
                }
                else if (line.match(/^(ƒê√°p √°n|Answer|Correct)[\:\s]*([ABCD])/i)) {
                    const match = line.match(/^(ƒê√°p √°n|Answer|Correct)[\:\s]*([ABCD])/i);
                    if (match) {
                        currentCorrect = match[2].toUpperCase();
                    }
                }
                else if (currentQuestion && Object.keys(currentAnswers).length === 0) {
                    currentQuestion += ' ' + line;
                }
            }
            
            if (currentQuestion && Object.keys(currentAnswers).length === 4 && currentCorrect) {
                previewQuestions.push({
                    question: currentQuestion,
                    answers: currentAnswers,
                    correct: currentCorrect
                });
            }
            
            if (previewQuestions.length > 0) {
                showPreview();
            } else {
                showToast('‚ö†Ô∏è', 'C·∫£nh b√°o', 'Kh√¥ng t√¨m th·∫•y c√¢u h·ªèi h·ª£p l·ªá!', 'warning');
            }
        }

        function showPreview() {
            const previewHtml = previewQuestions.map((question, index) => `
                <div class="border border-gray-200 rounded-lg p-4">
                    <div class="font-medium text-gray-800 mb-2">
                        C√¢u ${index + 1}: ${question.question}
                    </div>
                    <div class="text-sm text-gray-600 space-y-2">
                        <div>A. ${question.answers.A}</div>
                        <div>B. ${question.answers.B}</div>
                        <div>C. ${question.answers.C}</div>
                        <div>D. ${question.answers.D}</div>
                        <div class="font-medium text-green-600">ƒê√°p √°n: ${question.correct}</div>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('preview-content').innerHTML = previewHtml;
            document.getElementById('preview-questions').classList.remove('hidden');
        }

        function confirmImport() {
            const importCount = previewQuestions.length;
            questions.push(...previewQuestions);
            
            if (saveToDatabase()) {
                closeImportModal();
                loadQuestionsList();
                updateStatistics();
                updateQuestionSetDisplay();
                showToast('‚úÖ', 'Th√†nh c√¥ng', `ƒê√£ import ${importCount} c√¢u h·ªèi!`, 'success');
            }
        }

        function exportQuestions() {
            if (questions.length === 0) {
                showToast('‚ö†Ô∏è', 'C·∫£nh b√°o', 'Kh√¥ng c√≥ c√¢u h·ªèi ƒë·ªÉ export!', 'warning');
                return;
            }
            
            const createDocxContent = () => {
                let content = '';
                
                content += '<w:p><w:pPr><w:jc w:val="center"/><w:rPr><w:b/><w:sz w:val="32"/></w:rPr></w:pPr><w:r><w:rPr><w:b/><w:sz w:val="32"/></w:rPr><w:t>NG√ÇN H√ÄNG C√ÇU H·ªéI TR·∫ÆC NGHI·ªÜM</w:t></w:r></w:p>';
                content += '<w:p><w:pPr></w:pPr><w:r><w:t></w:t></w:r></w:p>';
                
                questions.forEach((question, index) => {
                    content += `<w:p><w:pPr><w:rPr><w:b/></w:rPr></w:pPr><w:r><w:rPr><w:b/></w:rPr><w:t>C√¢u ${index + 1}: ${escapeXml(question.question)}</w:t></w:r></w:p>`;
                    
                    content += `<w:p><w:pPr></w:pPr><w:r><w:t>A. ${escapeXml(typeof question.answers.A === 'object' ? question.answers.A.text : question.answers.A)}</w:t></w:r></w:p>`;
                    content += `<w:p><w:pPr></w:pPr><w:r><w:t>B. ${escapeXml(typeof question.answers.B === 'object' ? question.answers.B.text : question.answers.B)}</w:t></w:r></w:p>`;
                    content += `<w:p><w:pPr></w:pPr><w:r><w:t>C. ${escapeXml(typeof question.answers.C === 'object' ? question.answers.C.text : question.answers.C)}</w:t></w:r></w:p>`;
                    content += `<w:p><w:pPr></w:pPr><w:r><w:t>D. ${escapeXml(typeof question.answers.D === 'object' ? question.answers.D.text : question.answers.D)}</w:t></w:r></w:p>`;
                    
                    content += `<w:p><w:pPr><w:rPr><w:b/><w:color w:val="0000FF"/></w:rPr></w:pPr><w:r><w:rPr><w:b/><w:color w:val="0000FF"/></w:rPr><w:t>ƒê√°p √°n: ${question.correct}</w:t></w:r></w:p>`;
                    content += '<w:p><w:pPr></w:pPr><w:r><w:t></w:t></w:r></w:p>';
                });
                
                return content;
            };
            
            const escapeXml = (text) => {
                return text.replace(/&/g, '&amp;')
                          .replace(/</g, '&lt;')
                          .replace(/>/g, '&gt;')
                          .replace(/"/g, '&quot;')
                          .replace(/'/g, '&apos;');
            };
            
            const documentXml = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<w:document xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main">
    <w:body>
        ${createDocxContent()}
    </w:body>
</w:document>`;
            
            const appXml = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Properties xmlns="http://schemas.openxmlformats.org/officeDocument/2006/extended-properties">
    <Application>Quiz App</Application>
</Properties>`;
            
            const coreXml = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<cp:coreProperties xmlns:cp="http://schemas.openxmlformats.org/package/2006/metadata/core-properties" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:dcterms="http://purl.org/dc/terms/">
    <dc:title>Ng√¢n h√†ng c√¢u h·ªèi tr·∫Øc nghi·ªám</dc:title>
    <dc:creator>Quiz App</dc:creator>
    <dcterms:created>${new Date().toISOString()}</dcterms:created>
</cp:coreProperties>`;
            
            const relsXml = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
    <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="word/document.xml"/>
    <Relationship Id="rId2" Type="http://schemas.openxmlformats.org/package/2006/relationships/metadata/core-properties" Target="docProps/core.xml"/>
    <Relationship Id="rId3" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/extended-properties" Target="docProps/app.xml"/>
</Relationships>`;
            
            const contentTypesXml = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">
    <Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>
    <Default Extension="xml" ContentType="application/xml"/>
    <Override PartName="/word/document.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.document.main+xml"/>
    <Override PartName="/docProps/core.xml" ContentType="application/vnd.openxmlformats-package.core-properties+xml"/>
    <Override PartName="/docProps/app.xml" ContentType="application/vnd.openxmlformats-officedocument.extended-properties+xml"/>
</Types>`;
            
            const wordRelsXml = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
</Relationships>`;
            
            const zip = new JSZip();
            zip.file('[Content_Types].xml', contentTypesXml);
            zip.file('_rels/.rels', relsXml);
            zip.file('word/document.xml', documentXml);
            zip.file('word/_rels/document.xml.rels', wordRelsXml);
            zip.file('docProps/app.xml', appXml);
            zip.file('docProps/core.xml', coreXml);
            
            zip.generateAsync({type: 'blob', mimeType: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'})
                .then(function(content) {
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(content);
                    link.download = 'cau-hoi-trac-nghiem.docx';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(link.href);
                    
                    showToast('üì§', 'Th√†nh c√¥ng', 'ƒê√£ export ra Word!', 'success');
                });
        }

        // Ranking functions
        function loadRankings() {
            const results = JSON.parse(localStorage.getItem('quiz-results') || '[]');
            
            if (results.length === 0) {
                document.getElementById('ranking-list').innerHTML = 
                    '<div class="text-center text-gray-500 py-8">Ch∆∞a c√≥ k·∫øt qu·∫£ thi n√†o</div>';
                return;
            }
            
            results.sort((a, b) => {
                if (b.score !== a.score) return b.score - a.score;
                return a.timeSpent - b.timeSpent;
            });
            
            const rankingHtml = results.map((result, index) => {
                let medal = '';
                if (index === 0) medal = 'ü•á';
                else if (index === 1) medal = 'ü•à';
                else if (index === 2) medal = 'ü•â';
                
                const timeSpentMinutes = Math.floor(result.timeSpent / 60);
                const timeSpentSeconds = result.timeSpent % 60;
                
                return `
                    <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-all duration-300">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-4">
                                <div class="text-2xl font-bold text-gray-600">
                                    ${medal} #${index + 1}
                                </div>
                                <div>
                                    <div class="font-medium text-gray-800">${result.name}</div>
                                    <div class="text-sm text-gray-600">L·ªõp: ${result.class}</div>
                                    <div class="text-xs text-blue-600">üìö ${result.questionSetName || 'Kh√¥ng r√µ'}</div>
                                    <div class="text-xs text-gray-500">üìÖ ${result.examDate || 'Kh√¥ng r√µ'} - üïê ${result.examTime || 'Kh√¥ng r√µ'}</div>
                                </div>
                            </div>
                            <div class="flex items-center space-x-4">
                                <div class="text-right">
                                    <div class="text-2xl font-bold text-blue-600">${result.score.toFixed(2)}</div>
                                    <div class="text-sm text-gray-600">
                                        ${result.correctAnswers}/${result.totalQuestions} | ${timeSpentMinutes}:${timeSpentSeconds.toString().padStart(2, '0')}
                                    </div>
                                </div>
                                <button onclick="deleteResult(${index})" class="text-red-500 hover:text-red-700 p-2">üóëÔ∏è</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('ranking-list').innerHTML = rankingHtml;
        }

        function deleteResult(index) {
            showConfirmModal(
                'üóëÔ∏è X√≥a k·∫øt qu·∫£',
                'B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a k·∫øt qu·∫£ n√†y?',
                () => {
                    const results = JSON.parse(localStorage.getItem('quiz-results') || '[]');
                    results.splice(index, 1);
                    localStorage.setItem('quiz-results', JSON.stringify(results));
                    loadRankings();
                    updateStatistics();
                    showToast('‚úÖ', 'Th√†nh c√¥ng', 'ƒê√£ x√≥a k·∫øt qu·∫£!', 'success');
                }
            );
        }

        function clearAllResults() {
            const results = JSON.parse(localStorage.getItem('quiz-results') || '[]');
            if (results.length === 0) {
                showToast('‚ö†Ô∏è', 'C·∫£nh b√°o', 'Kh√¥ng c√≥ k·∫øt qu·∫£ ƒë·ªÉ x√≥a!', 'warning');
                return;
            }
            
            showConfirmModal(
                'üóëÔ∏è X√≥a t·∫•t c·∫£ k·∫øt qu·∫£',
                'B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a t·∫•t c·∫£ k·∫øt qu·∫£ thi?',
                () => {
                    localStorage.removeItem('quiz-results');
                    loadRankings();
                    updateStatistics();
                    showToast('‚úÖ', 'Th√†nh c√¥ng', 'ƒê√£ x√≥a t·∫•t c·∫£ k·∫øt qu·∫£!', 'success');
                }
            );
        }

        function exportResults() {
            const results = JSON.parse(localStorage.getItem('quiz-results') || '[]');
            
            if (results.length === 0) {
                showToast('‚ö†Ô∏è', 'C·∫£nh b√°o', 'Kh√¥ng c√≥ k·∫øt qu·∫£ ƒë·ªÉ export!', 'warning');
                return;
            }
            
            results.sort((a, b) => {
                if (b.score !== a.score) return b.score - a.score;
                return a.timeSpent - b.timeSpent;
            });
            
            const data = [
                ['STT', 'H·ªç t√™n', 'L·ªõp', 'B·ªô c√¢u h·ªèi', 'ƒêi·ªÉm', 'S·ªë c√¢u ƒë√∫ng', 'T·ªïng c√¢u', 'Th·ªùi gian (ph√∫t)', 'Ng√†y thi', 'Gi·ªù thi']
            ];
            
            results.forEach((result, index) => {
                const timeSpentMinutes = Math.round(result.timeSpent / 60 * 100) / 100;
                const date = result.examDate || new Date(result.timestamp).toLocaleDateString('vi-VN');
                const time = result.examTime || new Date(result.timestamp).toLocaleTimeString('vi-VN');
                
                data.push([
                    index + 1,
                    result.name,
                    result.class,
                    result.questionSetName || 'Kh√¥ng r√µ',
                    result.score,
                    result.correctAnswers,
                    result.totalQuestions,
                    timeSpentMinutes,
                    date,
                    time
                ]);
            });
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(data);
            
            XLSX.utils.book_append_sheet(wb, ws, "K·∫øt qu·∫£ thi");
            XLSX.writeFile(wb, "ket-qua-thi-trac-nghiem.xlsx");
            
            showToast('üìä', 'Th√†nh c√¥ng', 'ƒê√£ export ra Excel!', 'success');
        }

        // Modal functions
        function showConfirmModal(title, message, callback) {
            document.getElementById('confirm-title').textContent = title;
            document.getElementById('confirm-message').textContent = message;
            confirmCallback = callback;
            document.getElementById('confirm-modal').classList.remove('hidden');
        }

        function closeConfirmModal() {
            document.getElementById('confirm-modal').classList.add('hidden');
            confirmCallback = null;
        }

        function confirmAction() {
            if (confirmCallback) {
                confirmCallback();
            }
            closeConfirmModal();
        }

        // Toast notification
        function showToast(icon, title, message, type = 'info') {
            const toast = document.getElementById('toast');
            const toastIcon = document.getElementById('toast-icon');
            const toastTitle = document.getElementById('toast-title');
            const toastMessage = document.getElementById('toast-message');
            
            toastIcon.textContent = icon;
            toastTitle.textContent = title;
            toastMessage.textContent = message;
            
            const toastContent = toast.querySelector('div');
            toastContent.className = 'bg-white rounded-lg shadow-lg p-4 flex items-center space-x-3 min-w-80';
            
            if (type === 'success') {
                toastContent.classList.add('border-l-4', 'border-green-500');
            } else if (type === 'error') {
                toastContent.classList.add('border-l-4', 'border-red-500');
            } else if (type === 'warning') {
                toastContent.classList.add('border-l-4', 'border-yellow-500');
            } else {
                toastContent.classList.add('border-l-4', 'border-blue-500');
            }
            
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 4000);
        }

        // Initialize default tab
        switchTab('exam');
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9828024cb5f3dd8a',t:'MTc1ODQ0MTQxOC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
